<body>

<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="navbar-inner">
  <div class="container-fluid">
    <a class="brand" href="http://cms-sw.github.com/cmssw/faq.html">CMS Topic Collector - dev</a>
    <ul class="nav pull-right">
      <li class="dropdown">
        <a id="userInfo" class="dropdown-toggle" data-toggle="dropdown" href="#"></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
            <li id="userCern"></li>
            <li id="userGithub"></li>
            <li class="divider"></li>
            <li><a href="https://login.cern.ch/adfs/ls/?wa=wsignout1.0">Logout</a></li>
          </ul>
      </li>
    </ul>
  </div>
  </div>
</div>
<div class="row-fluid">
  <div class="container-fluid">
    <div id="myAlert" class="span12" style='padding: 15px;'></div>
  </div>
</div>
<div class="row-fluid">
  <div class="container-fluid">
    <div id="releaseTabs" class="span12"></div>
  </div>
</div>
<div class="row-fluid">
  <div class="container-fluid">
    <div id="myTable" class="span10"></div>
    <div style="padding-top: 10px" id="legend" class="span2">
      <table>
        <tr><td class='approved'>&#9679;</td><td>:</td><td>Approved</td></tr>
        <tr><td class='rejected'>&#9632;</td><td>:</td><td>Rejected</td></tr>
        <tr><td class='pending'>&#9650;</td><td>:</td><td>Signature pending</td></tr>
        <tr><td class='unaffected'>-</td><td>:</td><td>Unaffected</td></tr>
      </table>
    </div>
  </div>
</div>
<script>
var userInfo;
function enqueue() {
}

function updateSignatures(pullRequestId, newSignatures, categories, categoryNumber)
{
  var signatures = [];
  var signatureValues = {
    "signed": "<td align='middle' class='approved'>&#9679;</td>",
    "pending": "<td align='middle' class='pending'>&#9650;</td>",
  }
  // Reset all signatures.
  for (var si = 0; si < categoryNumber; ++si)
    signatures[si] = "<td align='middle'>-</td>";
  var canSign = false;
  // Change to active those for which we have a signature
  for (var signature in newSignatures)
  {
    for (var signable in userInfo["canSign"])
      if (signable == signature)
        canSign = true;
    signatures[categories[signature]] = signatureValues[newSignatures[signature]];
  }
  var canSignTxt = "<td>";
  if (canSign)
    canSignTxt += "<a class='btn btn-success btn-mini' id='sign_" + pullRequestId + "'><i class='icon-thumbs-up icon-white'></i> sign</a>" +
                  "&nbsp;<a class='btn btn-danger btn-mini' id='reject_" + pullRequestId + "'><i class='icon-thumbs-down icon-white'></i> reject</a>";
  if (userInfo["isAdmin"])
    canSignTxt += "&nbsp;<a class='btn btn-inverse btn-mini' id='signAll_" + pullRequestId + "'><i class='icon-thumbs-up icon-white'></i> sign all</a>";
  canSignTxt += "</td>";
  signatures[signatures.length] = canSignTxt;
  return signatures;
}

$(document).ready(function() {
  var userInfoPromise = $.post("api/auth").done(function(d,a,b) {
    $("#userInfo").html("Welcome " + d["firstname"] + "<b class='caret'></b>");
    $("#userCern").html("<a href='#'>CERN: " + d["user"] + "</a>");
    $("#userGithub").html("<a href='#'>github: " + d["githubUser"] + "</a>");
    var userCategories = d["categories"];
    var userCanSign = {}
    var mapEgroups = {
      "cms-git-core": "Core",
      "cms-git-analysis": "Analysis",
      "cms-git-alca": "AlCa",
      "cms-git-daq": "DAQ",
      "cms-git-dqm": "DQM",
      "cms-git-db": "DB",
      "cms-git-docs": "Docs",
      "cms-git-fastsim": "Fast simulation",
      "cms-git-simulation": "Simulation",
      "cms-git-generators": "Generators",
      "cms-git-geometry": "Geometry",
      "cms-git-hlt": "HLT",
      "cms-git-l1": "L1",
      "cms-git-operations": "Operations",
      "cms-git-reconstruction": "Reconstruction",
      "cms-git-visualization": "Visualization"
    }
    userInfo = d;
    for (var i = 0; i < userCategories.length; ++i) {
      if (userCategories[i] == "cms-git-admins")
        userInfo["isAdmin"] = true;
      var realName = mapEgroups[userCategories[i]];
      if (!realName)
        continue;
      userCanSign[mapEgroups[userCategories[i]]] = true;
    }
    userInfo["canSign"] = userCanSign;
    foo = userInfo;
  });

  var currentBranch = undefined;

  userInfoPromise.done(function () {  
    var currentBranchPromise = $.post("api/queues").done(function(d, a, b) {
      // Create the tabs
      var tabs = '<div class="navbar"><div class="navbar-inner"><ul class="nav">';
      if (d.length == 0)
      {
        $("#myAlert").html('<div class="alert alert-error"><strong>No CMSSW_X_Y_Z branches found.</strong></div></div>');
        $("#legend").hide();
        return;
      } 
        
      var currentBranch = d[0]["ref"];
      if (window.location.hash)
        currentBranch = window.location.hash.slice(1, window.location.hash.length);
      window.location.hash = "#" + currentBranch;
      for (var i = 0; i != d.length; ++i)
      {
        var r = d[i];
        tabs += "<li";
        if (currentBranch == r["ref"])
          tabs += ' class="active"';
        tabs += "><a href='#" + r["ref"] + "'>" + r["ref"]+ "</a></li>";
      }
      tabs += "</ul></div></div>";
      $("#releaseTabs").html(tabs);
      $("#myTable").html("<h2 class='releaseLink'>Open topics for <a class='relLink' href='https://github.com/cms-sw/cmssw/tree/" + currentBranch + "'>" + currentBranch + "</a> branch.</h2>" + 
                         "<table class='table table-condensed'><thead></thead><tbody></tbody></table>" +
                         "<a class='actionLink' href='https://github.com/" + userInfo["githubUser"] + 
                         "/cmssw/pull/new/cms-sw:" + currentBranch + "..." + userInfo["githubUser"] + ":master'>Create a new pull request for " + currentBranch + "</a>");
    }).done(function(d1, a1, b1) {
      var currentBranch = window.location.hash.slice(1, window.location.hash.length);
      $.post("api/queues/" + currentBranch).done(function(d,a,b) {
        if (!d)
        {
          $("#myTable").html("Cannot find any open pull request.");
          return;
        }
        var headers = [];
        var categoryNumber = 0;
        var categories = d["signing_categories"];
        for (var sci in categories)
        {
          headers[categories[sci]] = '<th><div class="vertical-text"><div class="vertical-text__inner">' + sci + "</div></div></th>";
          categoryNumber += 1;
        }
        $("#myTable thead").html("<tr><th>id</th><th>Pull request title</th>" + headers.join("") + "<th>Actions</th></tr>");

        var pullRequests = [];
        for (var pri in d["pull_requests"])
        {
          var pr = d["pull_requests"][pri];
          
          var signatures = updateSignatures(pr["number"], pr["signatures"], categories, categoryNumber);
          $("#myTable tbody").append("<tr id='pr" + pr["number"] + "' class='ui-widget-content'><td>" + pr["number"] +
                                     "</td><td class='title_cell'><a href='" + pr["html_url"] + "' target='_blank'>" + pr["title"] + "</a>" +
                                     "<span class='pullActions'>(<a target='_blank' href='https://github.com/cms-sw/cmssw/pull/" + pr["number"] + "/files'>diff</a>, " +
                                     "<a target='_blank' href='https://github.com/cms-sw/cmssw/pull/" + pr["number"] + "/commits'>history</a>)</span>" +
                                     "</td>" +
                                     signatures.join("") + 
                                     "</tr>");
          function signAlert(message) {
            $("#myAlert").html('<div class="alert alert-info">' + message + '.<a class="close" data-dismiss="alert" href="#">&times;</a></div></div>');
          }
          function errorAlert(message) {
            $("#myAlert").html('<div class="alert alert-error">' + message + '.<a class="close" data-dismiss="alert" href="#">&times;</a></div></div>');
          }

          function updateSuccessful(d,a,c)
          {
            // Update signarures
            $($("#pr" + d["pullRequest"] + " td")[0]).html("foo");
            $(".alert").alert('close');
          }

          function createActionCallback(n, api, action) {
            return function () {
              var actionLower = action.toLowerCase();
              signAlert("<strong>" + action + " pull request " + n + "<strong>");
              $.post("api/pulls/" + n + "/" + api).success(updateSuccessful).error(function(){errorAlert("An error occurred while " + actionLower + " " + n)});
              return false;
            };
          }
          $("#sign_" + pr["number"]).click(createActionCallback(pr["number"], "sign", "Signing")).error(function(){alert("Error while signing")});
          $("#reject_" + pr["number"]).click(createActionCallback(pr["number"], "reject", "Rejecting")).error(function(){alert("Error while rejecting")});
          $("#signAll_" + pr["number"]).click(createActionCallback(pr["number"], "signAll", "Signing all")).error(function(){alert("Error while rejecting")});
        }
      });
    });
  });
  return;
});
</script>
</body>
